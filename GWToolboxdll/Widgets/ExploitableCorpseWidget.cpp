#include "stdafx.h"

#include <GWCA/Constants/Constants.h>

#include <GWCA/GameEntities/Agent.h>
#include <GWCA/GameEntities/NPC.h>
#include <GWCA/GameEntities/Skill.h>

#include <GWCA/Managers/AgentMgr.h>
#include <GWCA/Managers/MapMgr.h>
#include <GWCA/Managers/SkillbarMgr.h>

#include <Defines.h>

#include "Utils/FontLoader.h"

#include <Widgets/ExploitableCorpseWidget.h>
#include <ImGuiAddons.h>

namespace {
    float range = GW::Constants::Range::Spellcast;
    float font_size = 24.f;
    bool only_show_if_player_has_exploitable_skill = true;

    bool checked_skills = false;
    bool has_exploitable_skill = false;

    GW::Skill* HasExploitableCorpseSkill()
    {
        const auto skillbar = GW::SkillbarMgr::GetPlayerSkillbar();
        if (!skillbar) return 0;
        for (auto& skill : skillbar->skills) {
            const auto skillData = GW::SkillbarMgr::GetSkillConstantData(skill.skill_id);
            if (skillData && skillData->ExploitsCorpse()) return skillData;
        }
        return 0;
    }

}

void ExploitableCorpseWidget::Draw(IDirect3DDevice9*)
{
    if (!visible || GW::Map::GetInstanceType() == GW::Constants::InstanceType::Outpost) {
        checked_skills = false;
        return;
    }
    if (!checked_skills && GW::SkillbarMgr::GetPlayerSkillbar()) {
        has_exploitable_skill = HasExploitableCorpseSkill() != nullptr;
        checked_skills = true;
    }
    if (!has_exploitable_skill && only_show_if_player_has_exploitable_skill) {
        return;
    }

    const GW::AgentArray* agents = GW::Agents::GetAgentArray();
    const GW::Agent* player = agents ? GW::Agents::GetObservingAgent() : nullptr;

    if (!agents || !player) {
        return;
    }

    unsigned int corpses_found = 0;

    for (auto* agent : *agents) {
        const GW::AgentLiving* living = agent ? agent->GetAsAgentLiving() : nullptr;

        if (!living || living->GetIsAlive() || living->GetIsUsedCorpse() || (GW::GetSquareDistance(player->pos, living->pos) > range * range)) {
            continue;
        }

        if (living->IsPlayer()) {
            corpses_found++;
        }
        else {
            const GW::NPC* npc = GW::Agents::GetNPCByID(living->player_number);
            if (npc && npc->IsFleshy()) {
                corpses_found++;
            }
        }
    }

    ImGui::PushStyleColor(ImGuiCol_WindowBg, ImVec4(0, 0, 0, 0));
    ImGui::SetNextWindowSize(ImVec2(250.0f, 90.0f), ImGuiCond_FirstUseEver);
    if (ImGui::Begin(Name(), nullptr, GetWinFlags())) {
        ImGui::PushFont(FontLoader::GetFontByPx(font_size), font_size);
        char corpses_count[32];
        snprintf(corpses_count, sizeof(corpses_count), "%u exploitable corpse%c", corpses_found, corpses_found != 1 ? 's' : '\0');
        ImGui::TextShadowed(corpses_count);
        ImGui::PopFont();
    }
    ImGui::End();
    ImGui::PopStyleColor();
}

void ExploitableCorpseWidget::DrawSettingsInternal()
{
    ImGui::DragFloat("Range", &range, 50.f, 0, GW::Constants::Range::Compass);
    ImGui::DragFloat("Text size", &font_size, 1.f, 16.f, 48.f);
    ImGui::Checkbox("Only show if you have a skill that exploits corpses", &only_show_if_player_has_exploitable_skill);
}

void ExploitableCorpseWidget::LoadSettings(ToolboxIni* ini)
{
    ToolboxWidget::LoadSettings(ini);
    LOAD_FLOAT(range);
    LOAD_FLOAT(font_size);
    LOAD_BOOL(only_show_if_player_has_exploitable_skill);
}

void ExploitableCorpseWidget::SaveSettings(ToolboxIni* ini)
{
    ToolboxWidget::SaveSettings(ini);
    SAVE_FLOAT(range);
    SAVE_FLOAT(font_size);
    SAVE_BOOL(only_show_if_player_has_exploitable_skill);
}
